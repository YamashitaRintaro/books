# 柔軟なインターフェースをつくる

オブジェクト同士は、オブジェクトが持つ「インターフェース」を介して会話しています。
本章では、インターフェースの理解、定義、そして最適化について詳しく解説します。

## インターフェースを定義する

クラスにはパブリックインターフェースとプライベートインターフェースが存在します。

### パブリックインターフェース

- クラスの主要な責任を明らかにする
- 外部から実行されることが想定される
- 気まぐれに変更されない
- 他者がそこに依存しても安全
- テストで完全に文書化されている

### プライベートインターフェース

- 実装の詳細に関わる
- 他のオブジェクトから送られてくることは想定されていない
- どんな理由でも変更されうる
- 他者がそこに依存するのは危険
- テストでは言及されないこともある

パブリックメソッドとプライベートメソッドに印をつけることで、クラスの使用者に対してどのメソッドが安全に依存できるかを示すことができます。

### 例：家電製品

家電製品には、ユーザーが操作できる「パブリック（公開された）」インターフェースがあります。
例えば、リモコンのボタンや表示パネルです。ユーザーはこれらのインターフェースを通じて家電製品を操作します。

家電製品内部では、多くのことが起こり、内部的なメッセージも数多くやり取りされています。
しかし、これらのメッセージは「プライベート（非公開）」であり、ユーザーからは見えません。

クラスはそれぞれが家電製品のようなもので、単一責任を果たすために存在しますが、メソッド自体はいくつも実装されています。
このうちいくつかは、そのクラスにとってリモコンのボタンのような存在であり、それはパブリックであるべきです。
その他の内部実装の詳細に関わるものはプライベートなメソッドです。

## パブリックインターフェースを見つける

アプリケーションの要件をユースケースとして捉え、それを満足させるために必要なオブジェクトとメッセージを見当をつけます。
では、どうやってパブリックインタフェースを設計していくのでしょうか。
著者はシーケンス図を勧めています。

シーケンス図を用いることで、オブジェクトとメッセージの流れを視覚化しやすくなります。
ユースケースでの名詞はシーケンス図ではオブジェクトになり、アクションはメッセージになります。

### 設計の重点をメッセージに置く

メッセージに基づく視点は、クラスに基づく視点よりも柔軟なアプリケーションを生み出します。
著者は以下のように強調しています。

>設計の質問が「このクラスが必要なのは知っているけど、これは何をすべきか」から「このメッセージを送る必要があるけど、誰が応答すべきか」に変えることが、設計者としてのキャリアの転機になります。

## 一番良い面（インターフェース）を表に出すコードを書く

### 明示的なインターフェースを作る

パブリックインターフェースに含まれるメソッドは以下のようであるべきです。

- 明示的にパブリックインターフェースだと特定できる
- 「どのように」よりも、「何を」になっている
- 名前は、考えられる限り変わり得ないもの
- オプション引数としてハッシュをとる

### public・protected・private

これら3つのキーワードは、メソッドの可視性と安定性を制御するために使われます。

- private：最も不安定な部類のメソッドを示し、設定される可視性は最も限定的です。プライベートメソッドは、受け手が省略された形式で呼び出されなければならず、逆に言えば、受け手が明示された状態では呼び出されるべきではありません。
- protected：不安定なメソッドを示しますが、可視性の制限が若干異なります。プロテクトされたメソッドは、受け手が`self`、もしくは`self`と同じクラスかサブクラスのインスタンスである場合にのみ、受け手を明示できます。
- public：メソッドが安定していることを示します。パブリックメソッドは、どこからでも見ることができます。

これらのキーワードを使うことで、将来のプログラマーが不用意に不安定なメソッドを使わないようにすることができます。

## デメテルの法則

デメテルの法則は、オブジェクトを疎結合にするためのコーディング規則です。
この法則に違反すると、パブリックインターフェースの正確な定義と特定ができていないことを示します。
しかし、設計の一要素でしかないので、違反しても実害がない場合もあります。

### デメテルの法則を定義する

デメテルの法則は、3つ目のオブジェクトにメッセージを送る際、異なる型の2つ目のオブジェクトを介することを禁じます。
例えば、次のようなコードは法則に違反しています。

```ruby
zip_code = order.customer.address.zip_code
```

### 違反を回避する

委譲を使うことで、デメテルの法則に違反することを避けられます。Rubyには`delegate.rb`や`forwardable.rb`があり、Ruby on Railsには`delegate`メソッドが用意されています。

デメテルの法則が伝えたいのは「委譲をもっと使いましょう」ということではなく、「何を」を求めて、メッセージチェーンを再考することです。メッセージに基づく視点に移行し、そのメッセージが自ずとオブジェクトのパブリックインターフェースとなるように設計することが重要です。

